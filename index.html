<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Local Datachat</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .narrative {
      max-width: 40rem;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg bg-body-tertiary" data-bs-theme="dark">
    <div class="container-fluid">
      <a class="navbar-brand" href=".">Datachat</a>
      <div class="collapse navbar-collapse" id="navbarContent">
        <div class="nav-item dropdown ms-auto" role="group" aria-label="Toggle dark mode" title="Toggle Dark Mode">
          <button class="dark-theme-toggle btn btn-outline-light dropdown-toggle" type="button"
            data-bs-toggle="dropdown" aria-expanded="false" aria-label="Toggle theme (auto)">
            <i class="bi bi-circle-half"></i> <span class="d-lg-none ms-2">Toggle theme</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><button class="dropdown-item" data-bs-theme-value="light"><i class="me-2 bi bi-sun-fill"></i>
                Light</button></li>
            <li><button class="dropdown-item" data-bs-theme-value="dark"><i class="me-2 bi bi-moon-stars-fill"></i>
                Dark</button></li>
            <li><button class="dropdown-item" data-bs-theme-value="auto"><i class="me-2 bi bi-circle-half"></i>
                Auto</button></li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <div class="container">
    <h1 class="mt-5 text-center">Local Datachat</h1>

    <h2>Upload CSV</h2>
    <input type="file" id="fileInput" />
    <div id="output"></div>

    <h2>Execute Query</h2>
    <textarea id="queryInput" rows="4" cols="50" placeholder="Enter your query here..."></textarea><br>
    <button onclick="executeQuery()">Execute Query</button>
    <button id="downloadButton">Download Table</button>

    <h2>Response</h2>
    <pre id="responseOutput" style="white-space: pre-wrap;"></pre>
  </div>

  <script>
    let uploadedDatasetName; // Declare the variable in the global scope
    let tableName; // Declare a global variable for the table name

    // Function to handle file upload
    async function uploadCSV() {
      const fileInput = document.getElementById('fileInput');
      if (!fileInput || !fileInput.files.length) {
        console.error('No file selected');
        return;
      }

      const formData = new FormData();
      formData.append('file', fileInput.files[0]);

      const response = await fetch('http://localhost:8020/upload_csv/', {
        method: 'POST',
        body: formData,
      });

      if (response.ok) {
        const data = await response.json();
        uploadedDatasetName = data.dataset_name; // Assign the dataset name to the variable
        tableName = uploadedDatasetName; // Set the global table name for downloading
        displayData(data); // Display schema and suggested questions
      } else {
        console.error('Error uploading CSV:', response.statusText);
      }
    }

    // Function to display the schema and suggested questions
    function displayData(data) {
      const outputDiv = document.getElementById('output');
      outputDiv.innerHTML = `
        <h3>Dataset Name: ${data.dataset_name}</h3>
        <pre>${JSON.stringify(data.schema, null, 2)}</pre>
        <h4>Suggested Questions:</h4>
        <pre>${data.suggested_questions}</pre>
      `;
    }

    // Function to handle the download button click
    document.getElementById('downloadButton').onclick = function () {
      if (!tableName) {
        console.error('No table name available for download.');
        return;
      }
      window.location.href = `http://localhost:8020/download/${tableName}`;
    };
    function extractSQLQuery(llmResponse) {
      const match = llmResponse.match(/```sql\n([\s\S]*?)\n```/); // Match content between ```sql and ```
      return match ? match[1].trim() : null; // Return the SQL query or null if not found
    }

    // Function to execute the query
    async function executeQuery() {
      const query = document.getElementById('queryInput').value.trim();
      console.log('Executing query:', query);
      if (!uploadedDatasetName) {
        console.error('No dataset uploaded. Please upload a CSV file first.');
        return;
      }

      if (!query) {
        console.error('Please enter a valid query.');
        return;
      }

      try {
        const response = await fetch('http://localhost:8020/query/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ dataset_name: uploadedDatasetName, query: query }),
        });

        if (!response.ok) {
          throw new Error(`Error executing query: ${response.statusText}`);
        }

        const result = await response.json();
        const sqlQuery = extractSQLQuery(result.llm_response);
        // Display the LLM response and SQL query execution result
        document.getElementById('responseOutput').textContent = `
          Response from LLM:\n${JSON.stringify(result.llm_response, null, 2)}\n
          SQL Query Execution Result:\n${JSON.stringify(result.result, null, 2)}
        `;
      } catch (error) {
        console.error(error.message);
      }
    }

    // Listen for the file input change event and automatically trigger file upload
    document.getElementById('fileInput').addEventListener('change', uploadCSV);

  </script>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@gramex/ui@0.3/dist/dark-theme.js" type="module"></script>

  <footer class="my-5 vh-100 d-flex align-items-center justify-content-center">
    <h1 class="display-6">Designed by <a href="https://gramener.com/"
        class="text-reset link-offset-3 link-underline link-underline-opacity-25">Gramener</a></h1>
  </footer>
</body>

</html>